<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø© â€“ Ø¬ÙˆØ¯Ø© Ø§Ù„Ù‡ÙˆØ§Ø¡ ÙÙŠ Ø§Ù„Ø¹Ø±Ø§Ù‚</title>

  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="ØªØ­Ù„ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØºØ¨Ø§Ø± ÙˆØ§Ù„Ø¹ÙˆØ§ØµÙ Ø§Ù„ØªØ±Ø§Ø¨ÙŠØ© Ø¹Ù„Ù‰ Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø©">

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  
  <!-- Chart.js for interactive plots -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  
  <!-- html2canvas for saving plots -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  
  <!-- App styles -->
  <link rel="stylesheet" href="css/style.css">

  <link rel="icon" href="assets/images/iraq_logo.svg" type="image/svg+xml">
  
  <style>
    /* Analysis-specific styles */
    .analysis-controls {
      background: rgba(0,0,0,0.02);
      border-radius: 1.5rem;
      padding: 2rem;
      margin: 2rem 0;
      border: 1px solid rgba(0,0,0,0.05);
    }
    
    .controls-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 1.5rem;
      margin-top: 1.5rem;
    }
    
    .control-group {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }
    
    .control-group label {
      font-weight: 600;
      color: var(--text-dark);
      font-size: 0.95rem;
    }
    
    .control-group select {
      padding: 0.8rem 1rem;
      border-radius: 2rem;
      border: 1px solid #ddd;
      background: white;
      font-family: inherit;
      font-size: 0.95rem;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .control-group select:hover {
      border-color: #888;
    }
    
    .control-group select:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.1);
    }
    
    .analysis-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 1.5rem;
      margin: 2rem 0;
    }
    
    .chart-card {
      background: white;
      border-radius: 1rem;
      padding: 1.5rem;
      box-shadow: 0 4px 6px rgba(0,0,0,0.05);
      border: 1px solid rgba(0,0,0,0.05);
      position: relative;
      overflow: hidden;
    }
    
    .watermark {
        position: absolute;
        bottom: 115px;
        left: 0;
        right: 0;
        margin: 0 auto;
        width: fit-content;
        opacity: 0.35;
        z-index: 10;
        pointer-events: none;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        font-size: 13px;
        color: #333;
        background: rgba(255, 255, 255, 0.7);
        padding: 4px 12px;
        border-radius: 30px;
        backdrop-filter: blur(2px);
        border: 1px solid rgba(0,0,0,0.05);
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
      }
    
    .watermark img {
      height: 25px;
      width: auto;
      opacity: 0.5;
    }
    
    .chart-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
      flex-wrap: wrap;
      gap: 1rem;
    }
    
    .chart-header h3 {
      margin: 0;
      font-size: 1.2rem;
    }
    
    .chart-controls {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
    }
    
    .chart-controls button {
      padding: 0.4rem 1rem;
      border-radius: 2rem;
      border: 1px solid #ddd;
      background: white;
      cursor: pointer;
      font-size: 0.85rem;
      transition: all 0.2s;
    }
    
    .chart-controls button:hover {
      background: #f0f0f0;
    }
    
    .chart-controls button.active {
      background: var(--primary-color);
      color: white;
      border-color: var(--primary-color);
    }
    
    .chart-actions {
      display: flex;
      gap: 0.5rem;
      margin-right: auto;
    }
    
    .chart-actions button {
      padding: 0.4rem;
      border-radius: 50%;
      width: 36px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      border: 1px solid #ddd;
      background: white;
      cursor: pointer;
      font-size: 1.2rem;
      transition: all 0.2s;
    }
    
    .chart-actions button:hover {
      background: #f0f0f0;
      transform: scale(1.05);
    }
    
    .stats-panel {
      background: white;
      border-radius: 1rem;
      padding: 1.2rem;
      box-shadow: 0 4px 6px rgba(0,0,0,0.05);
      border: 1px solid rgba(0,0,0,0.05);
      margin-top: 1rem;
    }
    
    .stats-panel h3 {
      margin-top: 0;
      margin-bottom: 1rem;
      font-size: 1.1rem;
    }
    
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 1rem;
    }
    
    .stat-item {
      padding: 0.8rem;
      background: #f8f9fa;
      border-radius: 0.8rem;
      text-align: center;
    }
    
    .stat-label {
      font-size: 0.85rem;
      color: #666;
      margin-bottom: 0.25rem;
    }
    
    .stat-value {
      font-size: 1.4rem;
      font-weight: 600;
      color: var(--primary-color);
      line-height: 1.2;
    }
    
    .stat-unit {
      font-size: 0.8rem;
      color: #666;
      font-weight: normal;
      margin-right: 0.2rem;
    }
    
    .loading-spinner {
      width: 40px;
      height: 40px;
      border: 3px solid #f3f3f3;
      border-top: 3px solid var(--primary-color);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 20px auto;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .chart-container {
      position: relative;
      min-height: 450px;
      width: 100%;
    }
    
    .analysis-footer {
      margin-top: 2rem;
      padding: 1rem;
      background: #f8f9fa;
      border-radius: 1rem;
      font-size: 0.9rem;
      color: #666;
    }
    
    .district-controls {
      display: flex;
      gap: 1rem;
      margin-bottom: 1.5rem;
      flex-wrap: wrap;
      align-items: center;
    }
    
    .district-controls select {
      padding: 0.5rem 1rem;
      border-radius: 2rem;
      border: 1px solid #ddd;
      background: white;
      font-family: inherit;
      font-size: 0.9rem;
      min-width: 200px;
    }
    
    .district-controls button {
      padding: 0.5rem 1.5rem;
      border-radius: 2rem;
      border: none;
      background: var(--primary-color);
      color: white;
      cursor: pointer;
      font-size: 0.9rem;
    }
    
    .district-controls button:hover {
      opacity: 0.9;
    }
    
    .plot-label {
      position: absolute;
      top: 150px;
      left: 510px;
      background: rgba(255, 255, 255, 0.9);
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 0.9rem;
      color: #333;
      z-index: 5;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      border: 1px solid rgba(0,0,0,0.05);
      pointer-events: none;
      backdrop-filter: blur(2px);
    }
    
    .province-header {
      display: flex;
      align-items: center;
      gap: 1rem;
      margin-bottom: 2rem;
    }
    
    .province-header h1 {
      margin: 0;
      font-size: 2rem;
      color: var(--primary-color);
    }
    
    .back-button {
      padding: 0.5rem 1.5rem;
      border-radius: 2rem;
      background: #f0f0f0;
      color: #333;
      text-decoration: none;
      font-size: 0.9rem;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    .back-button:hover {
      background: #e0e0e0;
    }
    
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.8);
    }
    
    .modal-content {
      position: relative;
      margin: 5% auto;
      padding: 20px;
      width: 90%;
      max-width: 1400px;
      background: white;
      border-radius: 1rem;
    }
    
    .close-modal {
      position: absolute;
      left: 20px;
      top: 10px;
      font-size: 32px;
      cursor: pointer;
      color: #666;
      z-index: 1001;
    }
    
    .close-modal:hover {
      color: #000;
    }
    
    .modal-chart {
      width: 100%;
      height: 80vh;
      position: relative;
    }
    
    .modal-chart .plot-label,
    .modal-chart .watermark {
      display: flex !important;
      z-index: 1001;
    }
    
    .modal-chart .plot-label {
      top: 70px;
      left: 900px;
      font-size: 1rem;
      padding: 8px 16px;
    }
    
    .modal-chart .watermark {
      bottom: 125px;
      opacity: 0.65;
      font-size: 14px;
      padding: 5px 15px;
    }
    
    .modal-chart .watermark img {
      height: 22px;
    }
    
    @media (max-width: 768px) {
      .stats-grid {
        grid-template-columns: repeat(2, 1fr);
      }
      
      .controls-grid {
        grid-template-columns: 1fr;
      }
      
      .chart-header {
        flex-direction: column;
        align-items: flex-start;
      }
      
      .province-header {
        flex-direction: column;
        align-items: flex-start;
      }
      
      .plot-label {
        top: 50px;
        left: 15px;
        font-size: 0.8rem;
        padding: 4px 8px;
      }
    }
  </style>
</head>

<body class="data-source-page">

<!-- ================= HEADER ================= -->
<header class="site-header">
  <div class="header-left">
    <a href="index.html" class="logo-link" id="logo-home">
      <img src="assets/images/logo.svg" alt="Iraq AQI" class="logo">
    </a>
  </div>

  <nav class="nav">
    <a href="index.html#map">Ø§Ù„Ø®Ø±ÙŠØ·Ø©</a>
    <a href="shako_mako.html">Ø´ÙƒÙˆ Ù…Ø§ÙƒÙˆ</a>

    <div class="nav-dropdown">
      <a href="#" class="dropdown-toggle">
        Ø­ÙˆÙ„ Ø§Ù„Ù…Ù†ØµØ© â–¾
      </a>
      <div class="dropdown-menu">
        <a href="about_AQI.html">Ù…Ø¤Ø´Ø± Ø§Ù„Ø¬ÙˆØ¯Ø©</a>
        <a href="why_IAQ.html">Ù…Ù†ØµØªÙ†Ø§</a>
        <a href="data_source.html">Ù…ØµØ§Ø¯Ø± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</a>
        <a href="contact.html">Ø§ØªØµÙ„ Ø¨Ù†Ø§</a>
      </div>
    </div>

    <div class="nav-dropdown">
      <a href="#" class="dropdown-toggle">
        Ø¨Ø­ÙˆØ« â–¾
      </a>
      <div class="dropdown-menu">
        <a href="research.html">ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</a>
      </div>
    </div>
  </nav>
</header>

<!-- ================= CONTENT ================= -->
<main class="page-container">
  <article class="page-content">

    <!-- Province Header with Back Button -->
    <div class="province-header">
      <a href="index.html#map" class="back-button">â† Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø®Ø±ÙŠØ·Ø©</a>
      <h1 id="province-name-ar">Ù…Ø­Ø§ÙØ¸Ø© Ø¨ØºØ¯Ø§Ø¯</h1>
      <span id="province-name-en" style="display: none;">Baghdad</span>
    </div>

    <p class="last-updated" id="last-updated-text">
      Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«: Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...
    </p>

    <!-- ================= ANALYSIS CONTROLS ================= -->
    <section class="analysis-controls">
      <h2>ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø£Ù‚Ø¶ÙŠØ© - <span id="province-name-in-controls">Ø¨ØºØ¯Ø§Ø¯</span></h2>
      <p>Ø§Ø®ØªØ± Ø§Ù„Ø£Ù‚Ø¶ÙŠØ© ÙˆØ§Ù„Ø³Ù†ÙˆØ§Øª Ù„Ù…Ù‚Ø§Ø±Ù†Ø© ØªØ±Ø§ÙƒÙŠØ² Ø§Ù„ØºØ¨Ø§Ø±</p>
      
      <div class="controls-grid">
        <!-- District Selection -->
        <div class="control-group">
          <label for="district-select">Ø§Ù„Ù‚Ø¶Ø§Ø¡</label>
          <select id="district-select" multiple size="5">
            <option value="all" selected>Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ù‚Ø¶ÙŠØ©</option>
          </select>
          <small>ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ø®ØªÙŠØ§Ø± Ø¹Ø¯Ø© Ø£Ù‚Ø¶ÙŠØ© (Ctrl+Click)</small>
        </div>
        
        <!-- Year Selection -->
        <div class="control-group">
          <label for="year-select">Ø§Ù„Ø³Ù†Ø©</label>
          <select id="year-select" multiple size="5">
            <option value="all" selected>Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø³Ù†ÙˆØ§Øª</option>
          </select>
          <small>Ø§Ø®ØªØ± Ø³Ù†Ø© Ø£Ùˆ Ø£ÙƒØ«Ø± Ù„Ù„Ù…Ù‚Ø§Ø±Ù†Ø©</small>
        </div>
        
        <!-- Period Selection -->
        <div class="control-group">
          <label for="period-select">Ù…Ø³ØªÙˆÙ‰ Ø§Ù„ØªØ¬Ù…ÙŠØ¹</label>
          <select id="period-select">
            <option value="daily">ÙŠÙˆÙ…ÙŠ</option>
            <option value="weekly" selected>Ø£Ø³Ø¨ÙˆØ¹ÙŠ</option>
            <option value="monthly">Ø´Ù‡Ø±ÙŠ</option>
          </select>
        </div>
        
        <!-- Chart Type Selection -->
        <div class="control-group">
          <label for="chart-type">Ù†ÙˆØ¹ Ø§Ù„Ø±Ø³Ù…</label>
          <select id="chart-type">
            <option value="line" selected>Ø®Ø·ÙŠ</option>
            <option value="bar">Ø£Ø¹Ù…Ø¯Ø©</option>
          </select>
        </div>
      </div>
      
      <div style="margin-top: 1rem; text-align: left;">
        <button id="update-chart" class="btn btn-primary">ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªØ­Ù„ÙŠÙ„ ğŸ“ŠğŸ”„</button>
        <button id="reset-filters" class="btn btn-secondary">Ø¹Ø±Ø¶ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ù‚Ø¶ÙŠØ© ğŸ“ŠğŸ”„</button>
      </div>
    </section>

    <!-- Main Chart - Full Width -->
    <div class="analysis-grid">
      <div class="chart-card" id="main-chart-card">
        <div class="watermark">
          <img src="assets/images/logo.svg" alt="Iraq AQI">
          <span>Dr. Omar Althuwaynee @iraqairquality</span>
        </div>
        <div class="chart-header">
          <h3 id="chart-title">Ø§ØªØ¬Ø§Ù‡Ø§Øª ØªØ±Ø§ÙƒÙŠØ² Ø§Ù„ØºØ¨Ø§Ø± - <span id="province-chart-title">Ø¨ØºØ¯Ø§Ø¯</span></h3>
          <div class="chart-actions">
            <button id="expand-main-chart" title="Ø¹Ø±Ø¶ Ø¨Ø§Ù„Ø´Ø§Ø´Ø© Ø§Ù„ÙƒØ§Ù…Ù„Ø©">â›¶</button>
            <button id="save-main-chart" title="Ø­ÙØ¸ ÙƒØµÙˆØ±Ø©">ğŸ“·</button>
          </div>
          <div class="chart-controls">
            <button class="active" data-view="median">Ø§Ù„ÙˆØ³ÙŠØ·</button>

          </div>
        </div>
        <div class="chart-container">
          <canvas id="dustChart"></canvas>
        </div>
        <div class="plot-label" id="y-axis-label">
          <span>Ø§Ù„ØªØ±ÙƒÙŠØ² (Âµg/mÂ³) - <span id="active-view-label">Ø§Ù„ÙˆØ³ÙŠØ·</span></span>
        </div>
      </div>
    </div>
    
    <!-- Statistics Panel - Horizontal Grid -->
    <div class="stats-panel">
      <h3>Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</h3>
      <div class="stats-grid" id="stats-content">
        <div class="loading-spinner"></div>
      </div>
    </div>
    
    <!-- ================= DISTRICT COMPARISON ================= -->
    <div class="chart-card" style="margin-top: 1.5rem;" id="comparison-chart-card">
      <div class="watermark">
        <img src="assets/images/logo.svg" alt="Iraq AQI">
        <span>Dr. Omar Althuwaynee @iraqairquality</span>
      </div>
      <div class="chart-header">
        <h3>Ù…Ù‚Ø§Ø±Ù†Ø© Ø¨ÙŠÙ† Ø§Ù„Ø£Ù‚Ø¶ÙŠØ© - <span id="province-comparison-title">Ø¨ØºØ¯Ø§Ø¯</span></h3>
        <div class="chart-actions">
          <button id="expand-comparison-chart" title="Ø¹Ø±Ø¶ Ø¨Ø§Ù„Ø´Ø§Ø´Ø© Ø§Ù„ÙƒØ§Ù…Ù„Ø©">â›¶</button>
          <button id="save-comparison-chart" title="Ø­ÙØ¸ ÙƒØµÙˆØ±Ø©">ğŸ“·</button>
        </div>
      </div>
      <div class="district-controls">
        <select id="comparison-stat">
          <option value="median">Ø§Ù„ÙˆØ³ÙŠØ·</option>

        </select>
        <select id="comparison-sort">
          <option value="none">Ø¨Ø¯ÙˆÙ† ØªØ±ØªÙŠØ¨</option>
          <option value="asc">ØªØµØ§Ø¹Ø¯ÙŠ (Ø§Ù„Ø£Ù‚Ù„ Ø£ÙˆÙ„Ø§Ù‹)</option>
          <option value="desc" selected>ØªÙ†Ø§Ø²Ù„ÙŠ (Ø§Ù„Ø£Ø¹Ù„Ù‰ Ø£ÙˆÙ„Ø§Ù‹)</option>
        </select>
        <button id="update-comparison">ğŸ”„ğŸ“Š ØªØ­Ø¯ÙŠØ«</button>    
      </div>
      <div class="chart-container" style="min-height: 450px;">
        <canvas id="comparisonChart"></canvas>
      </div>
    </div>
    
    <!-- ================= ANALYSIS FOOTER ================= -->
    <div class="analysis-footer">
      <div class="data-quality-indicator">
        <span>Ø¬ÙˆØ¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: </span>
        <span id="data-quality">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</span>
      </div>
      <div id="data-coverage"></div>
    </div>

  </article>
</main>

<!-- ================= FOOTER ================= -->
<footer>
  <div class="footer-content">
    <!-- Left: Logo + Copyright -->
    <div class="footer-left">
      <a href="index.html" class="footer-logo-link" id="footer-logo">
        <img src="./assets/images/logo.svg" alt="Iraq AQI" class="footer-logo">
      </a>
      <p class="footer-copyright">
        Â© 2026 Iraq Air Quality Platform. "For research & public awareness"
        <br>
        Numerical simulation & processing by Dr. Omar Althuwaynee
        <br>
        <small>(omar.faisel@gmail.com)</small>
      </p>
    </div>

    <!-- Center: Data source -->
    <div class="footer-center">
      <div class="data-source-wrapper">
        <span class="data-source-label">Data source:</span>
        <a href="https://dust.aemet.es/" 
           target="_blank" 
           rel="noopener noreferrer"
           title="Barcelona Dust Regional Center - WMO Regional Center for Dust Forecast">
          <img src="./assets/images/logo-bdrc-and-wmo.svg" 
               alt="Barcelona Dust Regional Center" 
               class="data-center-logo">
        </a>
        <a href="https://dust.aemet.es/" 
           target="_blank" 
           rel="noopener noreferrer" 
           class="data-center-link">
          dust.aemet.es
        </a>
      </div>
    </div>

    <!-- Right: Update time -->
    <div class="footer-right">
      <div id="ref-time"></div>
    </div>
  </div>

  <!-- Back to top button -->
  <button id="back-to-top" title="Back to top">â†‘</button>
</footer>

<!-- Modal for expanded chart -->
<div id="chart-modal" class="modal">
  <div class="modal-content">
    <span class="close-modal">&times;</span>
    <div id="modal-chart-container" class="modal-chart">
      <canvas id="modal-chart"></canvas>
    </div>
  </div>
</div>

<!-- ================= SCRIPTS ================= -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="js/main.js"></script>
<script src="js/translations.js"></script>
<script>
  // Make getArabicName globally available
  window.getArabicName = getArabicName;
  
  // Get province from URL parameters
  const urlParams = new URLSearchParams(window.location.search);
  const provinceName = urlParams.get('province') || 'Baghdad';
  const provinceArabic = getArabicName(provinceName, 'province') || provinceName;
  
  // Update page with province name
  document.getElementById('province-name-ar').textContent = provinceArabic;
  document.getElementById('province-name-en').textContent = provinceName;
  document.getElementById('province-name-in-controls').textContent = provinceArabic;
  document.getElementById('province-chart-title').textContent = provinceArabic;
  document.getElementById('province-comparison-title').textContent = provinceArabic;
  
  // Data Analysis Module for Province
  class ProvinceDataAnalyzer {
    constructor() {
      this.years = [];
      this.districts = [];
      this.districtMap = new Map(); // Map district names to IDs
      this.provinceName = provinceName;
      this.provinceArabic = provinceArabic;
      this.data = {};
      this.charts = {};
      this.currentView = 'median';
      this.comparisonStat = 'median';
      this.comparisonSort = 'desc';
      this.translations = window.IRAQ_TRANSLATIONS || {};
      this.init();
    }
    
    async init() {
      await this.loadMetadata();
      await this.loadAvailableYears();
      this.setupControls();
      this.setupEventListeners();
      this.updateLastModified();
    }
    
    translateDistrict(englishName) {
      return getArabicName(englishName, 'district') || englishName;
    }
    
    async loadMetadata() {
      try {
        // Load districts from districts.json
        const districtsRes = await fetch('data/historical/districts.json');
        if (districtsRes.ok) {
          const allDistricts = await districtsRes.json();
          
          // Filter districts by province
          this.districts = allDistricts.filter(d => d.province_name === this.provinceName);
          
          // Create mapping of district names to IDs
          this.districts.forEach(d => {
            this.districtMap.set(d.name, d.id);
            this.districtMap.set(d.id, d.name); // Also map ID to name for reverse lookup
          });
          
          // Populate district select with translated names
          const districtSelect = document.getElementById('district-select');
          districtSelect.innerHTML = '<option value="all" selected>Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ù‚Ø¶ÙŠØ©</option>';
          this.districts.forEach(d => {
            const option = document.createElement('option');
            option.value = d.name;
            option.textContent = this.translateDistrict(d.name);
            districtSelect.appendChild(option);
          });
          
          console.log(`Loaded ${this.districts.length} districts for ${this.provinceArabic}`);
        }
        
      } catch (error) {
        console.error('Error loading metadata:', error);
      }
    }
    
    async loadAvailableYears() {
      try {
        const indexRes = await fetch('data/historical/index.json');
        if (indexRes.ok) {
          const index = await indexRes.json();
          this.years = index.years || [];
        } else {
          this.years = [2024, 2025];
        }
        
        // Populate year select
        const yearSelect = document.getElementById('year-select');
        yearSelect.innerHTML = '<option value="all" selected>Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø³Ù†ÙˆØ§Øª</option>';
        this.years.sort().forEach(year => {
          const option = document.createElement('option');
          option.value = year;
          option.textContent = year;
          yearSelect.appendChild(option);
        });
        
      } catch (error) {
        console.error('Error loading index:', error);
      }
    }
    
    setupControls() {
      document.querySelectorAll('.chart-controls button').forEach(btn => {
        btn.addEventListener('click', (e) => {
          document.querySelectorAll('.chart-controls button').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          this.currentView = btn.dataset.view;
          
          const viewLabels = {
            'median': 'Ø§Ù„ÙˆØ³ÙŠØ·',
            'mean': 'Ø§Ù„Ù…ØªÙˆØ³Ø·',
            'min': 'Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰',
            'max': 'Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰'
          };
          document.getElementById('active-view-label').textContent = viewLabels[this.currentView];
          
          this.updateChart();
        });
      });
    }
    
    setupEventListeners() {
      document.getElementById('update-chart').addEventListener('click', () => this.updateChart());
      document.getElementById('reset-filters').addEventListener('click', () => this.resetFilters());
      document.getElementById('update-comparison').addEventListener('click', () => this.updateComparison());
      
      document.getElementById('expand-main-chart').addEventListener('click', () => this.expandChart('main'));
      document.getElementById('expand-comparison-chart').addEventListener('click', () => this.expandChart('comparison'));
      
      document.getElementById('save-main-chart').addEventListener('click', () => this.saveChart('main'));
      document.getElementById('save-comparison-chart').addEventListener('click', () => this.saveChart('comparison'));
      
      document.querySelector('.close-modal').addEventListener('click', () => {
        document.getElementById('chart-modal').style.display = 'none';
      });
      
      window.addEventListener('click', (e) => {
        const modal = document.getElementById('chart-modal');
        if (e.target === modal) {
          modal.style.display = 'none';
        }
      });
      
      document.getElementById('active-view-label').textContent = 'Ø§Ù„ÙˆØ³ÙŠØ·';
      
      // Initial chart load
      setTimeout(() => this.updateChart(), 500);
    }
    
    async loadData(years, period) {
      const allData = {};
      
      for (const year of years) {
        try {
          // For district-level data, load the compact JSON files
          let response;
          if (period === 'yearly') {
            response = await fetch(`data/historical/${year}/monthly_compact.json`);
          } else {
            response = await fetch(`data/historical/${year}/${period}_compact.json`);
          }
          
          if (response.ok) {
            const jsonData = await response.json();
            
            // Transform the data to a format similar to research.html
            // In research.html, they have: { period, year, values: { provinceName: { median, mean, min, max } } }
            // For districts, we want: { period, year, values: { districtName: { median, mean, min, max } } }
            const transformedData = this.transformDistrictData(jsonData, year);
            allData[year] = transformedData;
          }
        } catch (error) {
          console.warn(`No data for year ${year}:`, error);
        }
      }
      
      return allData;
    }
    
    transformDistrictData(jsonData, year) {
      // Create a map of periods to data
      const periodMap = new Map();
      
      jsonData.forEach(item => {
        const period = item.p || item.period;
        if (!period) return;
        
        if (!periodMap.has(period)) {
          periodMap.set(period, {
            period: period,
            year: year,
            values: {} // This will hold district values
          });
        }
        
        const periodEntry = periodMap.get(period);
        
        // For each district in this province, look for its ID in the item
        this.districts.forEach(district => {
          const districtId = district.id;
          const districtName = district.name;
          
          // In compact format, district values are stored with their ID as key
          if (item[districtId] !== undefined) {
            const value = item[districtId];
            
            // Store value with district name as key - same pattern as research.html
            periodEntry.values[districtName] = {
              median: value,
              mean: value,
              min: value,
              max: value
            };
          }
        });
      });
      
      return Array.from(periodMap.values());
    }
    
    async updateChart() {
      const districtSelect = document.getElementById('district-select');
      const selectedDistricts = Array.from(districtSelect.selectedOptions)
        .map(opt => opt.value)
        .filter(v => v !== 'all');
      
      const yearSelect = document.getElementById('year-select');
      const selectedYears = Array.from(yearSelect.selectedOptions)
        .map(opt => parseInt(opt.value))
        .filter(v => !isNaN(v) && v !== 'all');
      
      const period = document.getElementById('period-select').value;
      const chartType = document.getElementById('chart-type').value;
      
      const yearsToLoad = selectedYears.length ? selectedYears : this.years;
      const districtsToShow = selectedDistricts.length ? selectedDistricts : this.districts.map(d => d.name);
      
      console.log('Loading data for:', { yearsToLoad, districtsToShow, period });
      
      const data = await this.loadData(yearsToLoad, period);
      this.data = data;
      console.log('Loaded data:', data);
      
      this.renderChart(data, districtsToShow, chartType);
      this.updateStatistics(data, districtsToShow, yearsToLoad);
      this.renderComparison(data, districtsToShow, yearsToLoad);
    }
    
    renderChart(data, districts, chartType) {
      const ctx = document.getElementById('dustChart').getContext('2d');
      
      if (this.charts.main) {
        this.charts.main.destroy();
      }
      
      const datasets = [];
      const colors = ['#2563eb', '#dc2626', '#059669', '#d97706', '#7c3aed', '#db2777', '#0891b2', '#b45309'];
      
      // Collect all periods for labels
      const allPeriods = new Set();
      for (const [year, yearData] of Object.entries(data)) {
        yearData.forEach(item => {
          allPeriods.add(item.period);
        });
      }
      const sortedPeriods = Array.from(allPeriods).sort();
      
      console.log('Periods:', sortedPeriods);
      
      // For each selected district, create a dataset
      districts.forEach((districtName, idx) => {
        const districtData = [];
        
        // For each period, get the value for this district
        sortedPeriods.forEach(period => {
          let value = null;
          
          // Search through all years for this period
          for (const [year, yearData] of Object.entries(data)) {
            const periodItem = yearData.find(item => item.period === period);
            if (periodItem && periodItem.values && periodItem.values[districtName]) {
              value = periodItem.values[districtName][this.currentView];
              break;
            }
          }
          
          districtData.push(value);
        });
        
        // Only add dataset if there's any data
        if (districtData.some(v => v !== null)) {
          datasets.push({
            label: this.translateDistrict(districtName),
            data: districtData,
            borderColor: colors[idx % colors.length],
            backgroundColor: colors[idx % colors.length] + '20',
            tension: 0.1,
            fill: false,
            pointRadius: 4,
            pointHoverRadius: 6
          });
        }
      });
      
      this.charts.main = new Chart(ctx, {
        type: chartType,
        data: {
          labels: sortedPeriods,
          datasets: datasets
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'top',
              rtl: true,
              labels: { 
                font: { family: 'Cairo' },
                usePointStyle: true
              }
            },
            tooltip: {
              callbacks: {
                label: (context) => {
                  let label = context.dataset.label || '';
                  if (label) {
                    label += ': ';
                  }
                  if (context.raw !== null) {
                    label += context.raw.toFixed(1) + ' Âµg/mÂ³';
                  }
                  return label;
                }
              }
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              title: {
                display: true,
                text: 'Ø§Ù„ØªØ±ÙƒÙŠØ² (Âµg/mÂ³)',
                font: { family: 'Cairo' }
              }
            },
            x: {
              ticks: {
                maxRotation: 45,
                minRotation: 45
              }
            }
          }
        }
      });
    }
    
    updateStatistics(data, districts, years) {
      const statsContent = document.getElementById('stats-content');
      
      let allValues = [];
      const districtStats = {};
      
      for (const year of years) {
        if (data[year]) {
          data[year].forEach(item => {
            if (item.values) {
              districts.forEach(districtName => {
                if (item.values[districtName] && item.values[districtName][this.currentView] !== undefined) {
                  const value = item.values[districtName][this.currentView];
                  allValues.push(value);
                  
                  if (!districtStats[districtName]) {
                    districtStats[districtName] = [];
                  }
                  districtStats[districtName].push(value);
                }
              });
            }
          });
        }
      }
      
      if (allValues.length === 0) {
        statsContent.innerHTML = '<div class="stat-item">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ÙØªØ±Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©</div>';
        return;
      }
      
      const mean = allValues.reduce((a, b) => a + b, 0) / allValues.length;
      const sorted = [...allValues].sort((a, b) => a - b);
      const median = sorted[Math.floor(sorted.length / 2)];
      const max = Math.max(...allValues);
      const min = Math.min(...allValues);
      
      const squareDiffs = allValues.map(value => Math.pow(value - mean, 2));
      const avgSquareDiff = squareDiffs.reduce((a, b) => a + b, 0) / squareDiffs.length;
      const stdDev = Math.sqrt(avgSquareDiff);
      
      let highestDistrict = '';
      let highestAvg = 0;
      for (const [district, values] of Object.entries(districtStats)) {
        const avg = values.reduce((a, b) => a + b, 0) / values.length;
        if (avg > highestAvg) {
          highestAvg = avg;
          highestDistrict = district;
        }
      }
      
      statsContent.innerHTML = `
        <div class="stat-item">
          <div class="stat-label">Ø§Ù„Ù…ØªÙˆØ³Ø·</div>
          <div class="stat-value">${mean.toFixed(1)}<span class="stat-unit">Âµg/mÂ³</span></div>
        </div>
        <div class="stat-item">
          <div class="stat-label">Ø§Ù„ÙˆØ³ÙŠØ·</div>
          <div class="stat-value">${median.toFixed(1)}<span class="stat-unit">Âµg/mÂ³</span></div>
        </div>
        <div class="stat-item">
          <div class="stat-label">Ø§Ù„Ø§Ù†Ø­Ø±Ø§Ù</div>
          <div class="stat-value">${stdDev.toFixed(1)}<span class="stat-unit">Âµg/mÂ³</span></div>
        </div>
        <div class="stat-item">
          <div class="stat-label">Ø§Ù„Ø£Ø¹Ù„Ù‰</div>
          <div class="stat-value">${max.toFixed(1)}<span class="stat-unit">Âµg/mÂ³</span></div>
        </div>
        <div class="stat-item">
          <div class="stat-label">Ø§Ù„Ø£Ø¯Ù†Ù‰</div>
          <div class="stat-value">${min.toFixed(1)}<span class="stat-unit">Âµg/mÂ³</span></div>
        </div>
        <div class="stat-item">
          <div class="stat-label">Ø£Ø¹Ù„Ù‰ Ù‚Ø¶Ø§Ø¡</div>
          <div class="stat-value">${this.translateDistrict(highestDistrict)}</div>
          <div class="stat-unit">${highestAvg.toFixed(1)} Âµg/mÂ³</div>
        </div>
        <div class="stat-item">
          <div class="stat-label">Ø¹Ø¯Ø¯ Ø§Ù„Ù‚ÙŠØ§Ø³Ø§Øª</div>
          <div class="stat-value">${allValues.length.toLocaleString()}</div>
        </div>
      `;
    }
    
    renderComparison(data, districts, years) {
      const ctx = document.getElementById('comparisonChart').getContext('2d');
      
      if (this.charts.comparison) {
        this.charts.comparison.destroy();
      }
      
      const districtData = [];
      
      districts.forEach(districtName => {
        const values = [];
        
        for (const year of years) {
          if (data[year]) {
            const yearValues = data[year]
              .map(item => item.values && item.values[districtName] ? 
                    item.values[districtName][this.comparisonStat] : null)
              .filter(v => v !== null);
            
            if (yearValues.length > 0) {
              const avg = yearValues.reduce((a, b) => a + b, 0) / yearValues.length;
              values.push(avg);
            }
          }
        }
        
        if (values.length > 0) {
          const overallAvg = values.reduce((a, b) => a + b, 0) / values.length;
          districtData.push({
            district: districtName,
            arabicName: this.translateDistrict(districtName),
            value: overallAvg
          });
        }
      });
      
      if (this.comparisonSort === 'asc') {
        districtData.sort((a, b) => a.value - b.value);
      } else if (this.comparisonSort === 'desc') {
        districtData.sort((a, b) => b.value - a.value);
      }
      
      const colors = ['#2563eb', '#dc2626', '#059669', '#d97706', '#7c3aed', '#db2777', '#0891b2', '#b45309'];
      
      const datasets = [{
        label: this.getStatLabel(this.comparisonStat),
        data: districtData.map(d => d.value),
        backgroundColor: districtData.map((_, idx) => colors[idx % colors.length] + '80'),
        borderColor: districtData.map((_, idx) => colors[idx % colors.length]),
        borderWidth: 1
      }];
      
      this.charts.comparison = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: districtData.map(d => d.arabicName),
          datasets: datasets
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          indexAxis: 'y',
          plugins: {
            legend: { display: false },
            tooltip: {
              callbacks: {
                label: (context) => context.raw.toFixed(1) + ' Âµg/mÂ³'
              }
            }
          },
          scales: {
            x: {
              beginAtZero: true,
              title: { 
                display: true, 
                text: `Ø§Ù„ØªØ±ÙƒÙŠØ² (Âµg/mÂ³) - ${this.getStatLabel(this.comparisonStat)}`,
                font: { family: 'Cairo' }
              }
            },
            y: { grid: { display: false } }
          }
        }
      });
    }
    
    getStatLabel(stat) {
      const labels = {
        'median': 'Ø§Ù„ÙˆØ³ÙŠØ·',
        'mean': 'Ø§Ù„Ù…ØªÙˆØ³Ø·',
        'min': 'Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰',
        'max': 'Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰'
      };
      return labels[stat] || stat;
    }
    
    expandChart(chartType) {
      const modal = document.getElementById('chart-modal');
      const modalContainer = document.getElementById('modal-chart-container');
      const modalCanvas = document.getElementById('modal-chart');
      
      modal.style.display = 'block';
      
      // Clear any previous content in modal container
      modalContainer.innerHTML = '<canvas id="modal-chart" class="modal-chart"></canvas>';
      const newModalCanvas = document.getElementById('modal-chart');
      
      // Clone the plot label and watermark from original chart
      const originalChartCard = document.getElementById(`${chartType}-chart-card`);
      const originalPlotLabel = originalChartCard.querySelector('.plot-label');
      const originalWatermark = originalChartCard.querySelector('.watermark');
      
      if (originalPlotLabel) {
        const clonedLabel = originalPlotLabel.cloneNode(true);
        clonedLabel.id = 'modal-plot-label';
        modalContainer.appendChild(clonedLabel);
      }
      
      if (originalWatermark) {
        const clonedWatermark = originalWatermark.cloneNode(true);
        clonedWatermark.id = 'modal-watermark';
        modalContainer.appendChild(clonedWatermark);
      }
      
      // Small delay to ensure modal is visible
      setTimeout(() => {
        const ctx = newModalCanvas.getContext('2d');
        
        if (chartType === 'main' && this.charts.main) {
          new Chart(ctx, {
            type: this.charts.main.config.type,
            data: JSON.parse(JSON.stringify(this.charts.main.data)),
            options: {
              ...this.charts.main.options,
              maintainAspectRatio: false,
              responsive: true,
              plugins: {
                ...this.charts.main.options.plugins,
                legend: { ...this.charts.main.options.plugins.legend, position: 'top' }
              }
            }
          });
        } else if (chartType === 'comparison' && this.charts.comparison) {
          new Chart(ctx, {
            type: this.charts.comparison.config.type,
            data: JSON.parse(JSON.stringify(this.charts.comparison.data)),
            options: {
              ...this.charts.comparison.options,
              maintainAspectRatio: false,
              responsive: true,
              indexAxis: 'y',
              plugins: {
                ...this.charts.comparison.options.plugins,
                legend: { display: false }
              }
            }
          });
        }
      }, 100);
    }
    

    saveChart(chartType) {
      const chartId = chartType === 'main' ? 'main-chart-card' : 'comparison-chart-card';
      const chartCard = document.getElementById(chartId);
      
      html2canvas(chartCard, {
        scale: 2,
        backgroundColor: '#ffffff',
        logging: false,
        allowTaint: true,
        useCORS: true
      }).then(canvas => {
        const link = document.createElement('a');
        link.download = `iraq-${this.provinceName}-${chartType}-chart.png`;
        link.href = canvas.toDataURL('image/png');
        link.click();
      }).catch(error => {
        console.error('Error saving chart:', error);
        alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­ÙØ¸ Ø§Ù„ØµÙˆØ±Ø©');
      });
    }
    
    resetFilters() {
      const districtSelect = document.getElementById('district-select');
      for (let option of districtSelect.options) {
        option.selected = option.value === 'all';
      }
      
      const yearSelect = document.getElementById('year-select');
      for (let option of yearSelect.options) {
        option.selected = option.value === 'all';
      }
      
      document.getElementById('period-select').value = 'weekly';
      document.getElementById('chart-type').value = 'line';
      
      document.querySelectorAll('.chart-controls button').forEach(btn => {
        btn.classList.remove('active');
        if (btn.dataset.view === 'median') {
          btn.classList.add('active');
        }
      });
      this.currentView = 'median';
      document.getElementById('active-view-label').textContent = 'Ø§Ù„ÙˆØ³ÙŠØ·';
      
      document.getElementById('comparison-stat').value = 'median';
      document.getElementById('comparison-sort').value = 'desc';
      this.comparisonStat = 'median';
      this.comparisonSort = 'desc';
      
      this.updateChart();
    }
    
    updateLastModified() {
      const lastModified = new Date(document.lastModified);
      const options = { 
        weekday: 'long', 
        year: 'numeric', 
        month: 'long', 
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      };
      document.getElementById('last-updated-text').textContent = 
        `Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«: ${lastModified.toLocaleDateString('ar-IQ', options)} (ØªÙˆÙ‚ÙŠØª Ø¨ØºØ¯Ø§Ø¯)`;
      
      document.getElementById('data-quality').textContent = 'Ø¬ÙŠØ¯Ø©';
      document.getElementById('data-coverage').innerHTML = 
        `Ù…Ø­Ø§ÙØ¸Ø©: ${this.provinceArabic} - ${this.districts.length} Ù‚Ø¶Ø§Ø¡`;
    }
    
    updateComparison() {
      this.comparisonStat = document.getElementById('comparison-stat').value;
      this.comparisonSort = document.getElementById('comparison-sort').value;
      
      const districtSelect = document.getElementById('district-select');
      const selectedDistricts = Array.from(districtSelect.selectedOptions)
        .map(opt => opt.value)
        .filter(v => v !== 'all');
      
      const yearSelect = document.getElementById('year-select');
      const selectedYears = Array.from(yearSelect.selectedOptions)
        .map(opt => parseInt(opt.value))
        .filter(v => !isNaN(v) && v !== 'all');
      
      const period = document.getElementById('period-select').value;
      
      const yearsToLoad = selectedYears.length ? selectedYears : this.years;
      const districtsToShow = selectedDistricts.length ? selectedDistricts : this.districts.map(d => d.name);
      
      this.renderComparison(this.data, districtsToShow, yearsToLoad);
    }
  }
  
  // Initialize analyzer when page loads
  document.addEventListener('DOMContentLoaded', () => {
    window.analyzer = new ProvinceDataAnalyzer();
  });
</script>

</body>
</html>